import XCTest
@testable import EmojiPickerKit

final class Step2_SkinToneNormalizerTests: XCTestCase {

    // MARK: - scalar property

    func test_scalar_stripIsNil() {
        XCTAssertNil(EmojiSkinToneNormalization.strip.scalar)
    }

    func test_scalar_toneValues() {
        XCTAssertEqual(EmojiSkinToneNormalization.light.scalar, Unicode.Scalar(0x1F3FB))
        XCTAssertEqual(EmojiSkinToneNormalization.mediumLight.scalar, Unicode.Scalar(0x1F3FC))
        XCTAssertEqual(EmojiSkinToneNormalization.medium.scalar, Unicode.Scalar(0x1F3FD))
        XCTAssertEqual(EmojiSkinToneNormalization.mediumDark.scalar, Unicode.Scalar(0x1F3FE))
        XCTAssertEqual(EmojiSkinToneNormalization.dark.scalar, Unicode.Scalar(0x1F3FF))
    }

    // MARK: - .strip

    func test_strip_removesMediumTone() {
        XCTAssertEqual("ğŸ‘‹ğŸ½".normalizingSkinTone(to: .strip), "ğŸ‘‹")
    }

    func test_strip_removesLightTone() {
        XCTAssertEqual("ğŸ‘‹ğŸ»".normalizingSkinTone(to: .strip), "ğŸ‘‹")
    }

    func test_strip_removesDarkTone() {
        XCTAssertEqual("ğŸ‘‹ğŸ¿".normalizingSkinTone(to: .strip), "ğŸ‘‹")
    }

    func test_strip_nonModifierBaseUnchanged() {
        XCTAssertEqual("ğŸ˜Š".normalizingSkinTone(to: .strip), "ğŸ˜Š")
    }

    func test_strip_alreadyDefaultUnchanged() {
        XCTAssertEqual("ğŸ‘‹".normalizingSkinTone(to: .strip), "ğŸ‘‹")
    }

    // MARK: - tone replacement

    func test_replaceTone_mediumToDark() {
        XCTAssertEqual("ğŸ‘‹ğŸ½".normalizingSkinTone(to: .dark), "ğŸ‘‹ğŸ¿")
    }

    func test_replaceTone_mediumToLight() {
        XCTAssertEqual("ğŸ‘‹ğŸ½".normalizingSkinTone(to: .light), "ğŸ‘‹ğŸ»")
    }

    func test_replaceTone_mediumToSame() {
        XCTAssertEqual("ğŸ‘‹ğŸ½".normalizingSkinTone(to: .medium), "ğŸ‘‹ğŸ½")
    }

    func test_addTone_bareBaseToDark() {
        XCTAssertEqual("ğŸ‘‹".normalizingSkinTone(to: .dark), "ğŸ‘‹ğŸ¿")
    }

    func test_addTone_nonModifierBaseReturnsBase() {
        // ğŸ˜Š is not Emoji_Modifier_Base â†’ no modifier appended
        XCTAssertEqual("ğŸ˜Š".normalizingSkinTone(to: .dark), "ğŸ˜Š")
    }

    // MARK: - ZWJ sequences

    func test_zwj_skinToneHair_stripRemovesTone() {
        // ğŸ‘©ğŸ½â€ğŸ¦° â†’ strip â†’ ğŸ‘©â€ğŸ¦°
        XCTAssertEqual("ğŸ‘©ğŸ½â€ğŸ¦°".normalizingSkinTone(to: .strip), "ğŸ‘©â€ğŸ¦°")
    }

    func test_zwj_skinToneHair_replaceTone() {
        // ğŸ‘©ğŸ½â€ğŸ¦° â†’ dark â†’ ğŸ‘©ğŸ¿â€ğŸ¦°
        XCTAssertEqual("ğŸ‘©ğŸ½â€ğŸ¦°".normalizingSkinTone(to: .dark), "ğŸ‘©ğŸ¿â€ğŸ¦°")
    }

    func test_zwj_family_darkAppliesToAllMembers() {
        // ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ â†’ dark â†’ all four members get dark skin tone
        XCTAssertEqual(
            "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦".normalizingSkinTone(to: .dark),
            "ğŸ‘¨ğŸ¿â€ğŸ‘©ğŸ¿â€ğŸ‘§ğŸ¿â€ğŸ‘¦ğŸ¿"
        )
    }

    func test_zwj_familyStrip_removesAllTones() {
        // ğŸ‘¨ğŸ¿â€ğŸ‘©ğŸ¿â€ğŸ‘§ğŸ¿â€ğŸ‘¦ğŸ¿ â†’ strip â†’ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦
        XCTAssertEqual(
            "ğŸ‘¨ğŸ¿â€ğŸ‘©ğŸ¿â€ğŸ‘§ğŸ¿â€ğŸ‘¦ğŸ¿".normalizingSkinTone(to: .strip),
            "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"
        )
    }

    func test_zwj_profession_lightAppliesTone() {
        // ğŸ‘©â€ğŸ’» â†’ light â†’ ğŸ‘©ğŸ»â€ğŸ’»
        XCTAssertEqual("ğŸ‘©â€ğŸ’»".normalizingSkinTone(to: .light), "ğŸ‘©ğŸ»â€ğŸ’»")
    }

    func test_zwj_profession_replaceTone() {
        // ğŸ§‘ğŸ¿â€ğŸ’» â†’ medium â†’ ğŸ§‘ğŸ½â€ğŸ’»
        XCTAssertEqual("ğŸ§‘ğŸ¿â€ğŸ’»".normalizingSkinTone(to: .medium), "ğŸ§‘ğŸ½â€ğŸ’»")
    }

    func test_zwj_genderedActivity_stripRemovesTone() {
        // ğŸƒğŸ½â€â™€ï¸ â†’ strip â†’ ğŸƒâ€â™€ï¸
        XCTAssertEqual("ğŸƒğŸ½â€â™€ï¸".normalizingSkinTone(to: .strip), "ğŸƒâ€â™€ï¸")
    }

    func test_zwj_genderedActivity_applyTone() {
        // ğŸƒâ€â™€ï¸ â†’ dark â†’ ğŸƒğŸ¿â€â™€ï¸
        XCTAssertEqual("ğŸƒâ€â™€ï¸".normalizingSkinTone(to: .dark), "ğŸƒğŸ¿â€â™€ï¸")
    }

    func test_zwj_nonPersonEmoji_unchanged() {
        // ğŸ³ï¸â€ğŸŒˆ â€” no modifier base, stays unchanged
        XCTAssertEqual("ğŸ³ï¸â€ğŸŒˆ".normalizingSkinTone(to: .dark), "ğŸ³ï¸â€ğŸŒˆ")
    }

    // MARK: - Edge cases

    func test_emptyString() {
        XCTAssertEqual("".normalizingSkinTone(to: .strip), "")
    }
}
